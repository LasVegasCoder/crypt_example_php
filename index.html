<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>#MetaAPI</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
	<link rel="stylesheet" href="static/css/main.css">
</head>
<body>
	<div class="container">

		<h1>#MetaAPI</h1>
		<h5>Developers API for #MHC transactions in #MetaHash network</h5>

		<form id="transactionform" class="mt-5">
			<div class="dropdown float-right text-muted mt-1">
				<a id="network-title" class="btn dropdown-toggle" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-net="dev">
					Current network: <span>dev</span>
				</a>
				<div id="network-select" class="dropdown-menu" aria-labelledby="dropdownMenuLink">
					<a class="dropdown-item" data-net="dev">dev</a>
					<a class="dropdown-item" data-net="test">test</a>
					<a class="dropdown-item" data-net="main">main</a>
				</div>
			</div>			
			<h2>
				Send transations to #MetaHash
			</h2>
			<div class="row mt-3">
				<div class="col-sm-12 col-md-3">
					<div class="form-group">
						<label for="transactionform_value">#MHC value to send:</label>
						<input type="text" class="form-control form-control-lg" id="transactionform_value"  value="0">
					</div>
				</div>
				<div class="col-sm-12 col-md-3">
					<div class="form-group">
						<label for="transactionform_fee">Max fee:</label>
						<input type="text" class="form-control form-control-lg" id="transactionform_fee"  value="0" disabled>
					</div>
				</div>
				<div class="col-sm-12 col-md-6">
					<div class="form-group">
						<label for="transactionform_data">Transaction data:</label>
						<input type="text" class="form-control form-control-lg" id="transactionform_data"  value="">
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<div class="form-group">
						<label class="float-right text-muted">
							Copy your private keys to <code>data/</code> folder to appear in the list or <a href="#walletcreateform">create a new wallet</a>
						</label>
						<label for="transactionform_address">
							From wallet:
						</label>
						<select class="form-control form-control-lg selectpicker" id="transactionform_address"></select>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12 col-md-8">
					<div class="form-group">
						<label for="transactionform_to">To #MHC address:</label>
						<input type="text" class="form-control form-control-lg" id="transactionform_to" value="">
					</div>
				</div>
				<div class="col-sm-12 col-md-4">
					<div class="form-group">
						<label for="">&nbsp;</label>
						<button class="btn btn-primary form-control form-control-lg" id="btn-send-tx">
							<span class="spinner_reason">Send transaction</span>
							<div class="spinner">
								<div class="bounce1"></div>
								<div class="bounce2"></div>
								<div class="bounce3"></div>
							</div>
						</button>
					</div>
				</div>
			</div>
		</form>

		<div id="transactionlogs_wrap" class="mt-4">
			<div class="row">
				<div class="col-md-12">
					<textarea id="transactionlogs" placeholder="No logs to show" readonly=""></textarea>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<button class="btn btn-primary btn-sm" id="transactionlogs_copy" disabled>Copy</button>
					<button class="btn btn-primary btn-sm" id="transactionlogs_clear" disabled>Clear</button>
				</div>
			</div>
		</div>


		<div id="transactionlogs_wrap" class="mt-4">
			<h4>Last transactions</h4>

			<div class="row">
				<div class="col-md-12 no-more-tables">
					<table class="api__lasttrans-table" id="transactionshistory">
						<thead>
							<tr>
								<th>From</th>
								<th>To</th>
								<th>Value</th>
								<th>Status</th>
							</tr>
						</thead>
						<tbody>
							<tr class="api__empty_lastransrow">
								<td colspan="4">No transactions to show</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<div class="mt-5">
			<h2>
				Developer information
			</h2>

			<h4 class="mt-4">
				Files and functions
			</h4>
			<div class="api__overdevinf-block">
				<div class="row">
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>data/[wallet address].mh</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Keys files to sign #MetaHash transactions</div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>crypt_example.php</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Connects to #MetaHash protocol</div>
		
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>README.md</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Full API instructions</div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>index.html</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Test-tool to send test transactions</div>
				</div>
			</div>

			<h4 class="mt-5">
				API Calls
			</h4>
			<div class="api__overdevinf-block">
				<div class="row">
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>generate</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Generate MH address</div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>fetch-balance</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Get balance for MH address</div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>fetch-history</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Get history for MH address</div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>get-tx</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Get transaction information by hash</div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1"><code>send-tx</code></div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2">Create and send transaction</div>
				</div>
			</div>

			<h4 class="mt-5">
				Additional information
			</h4>
			<div class="api__overdevinf-block">
				<div class="row">
					<div class="col-md-5 col-sm-12 api__devinf-block row1">#MetaHash Developer Portal</div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2"><a href="https://support.metahash.org" target="_blank">https://support.metahash.org</a></div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1">#MetaHash in GitHub</div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2"><a href="https://github.com/metahashorg" target="_blank">https://github.com/metahashorg</a></div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1">Contact Support</div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2"><a href="mailto:support@metahash.org">support@metahash.org</a></div>
					<div class="col-md-5 col-sm-12 api__devinf-block row1">#MetaHash Website</div>
					<div class="col-md-7 col-sm-12 api__devinf-block row2"><a href="https://metahash.org" target="_blank">https://metahash.org</a></div>
				</div>
			</div>
		</div>
		<div id="walletcreateform" class="mt-5">
			<h2>
				Create new wallet
			</h2>
			<div class="row">						
				<div class="col-lg-5 col-md-5">
					<div class="form-group">
						<label for="createwallet_button">Wallet keyfile will be stored in <code>data/</code></label>
						<button class="btn btn-primary form-control form-control-lg" id="createwallet_button">
							<span class="spinner_reason">Create wallet</span>
							<div class="spinner">
								<div class="bounce1"></div>
								<div class="bounce2"></div>
								<div class="bounce3"></div>
							</div>
						</button>
					</div>
				</div>
				<div class="col-lg-7 col-md-7">
					<div class="form-group">
						<label for="transactionform_to">Wallet address:</label>
						<input type="text" class="form-control form-control-lg" id="createwallet_input" value="" placeholder="Here will be your new wallet address" readonly>
					</div>
				</div>
			</div>
			<div class="row">						
				<div class="col-lg-12 col-md-12">
					<div class="t-tle">
						<div class="t-row">
							<div class="t-cell">
								<p class="api__create-hint success" id="createwallet_success" style="display: none">
									Wallet successfully created.
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<footer>
			<div class="float-right"><img class="api__foot-logo" src="static/images/logo_mail.svg" alt=""></div>
			<p class="api__foot-text">
				Copyright Â© 2017-2018 #MetaHash.<br> All Rights Reserved
			</p>
		</footer>
	</div>

	<!-- Modal -->
	<div class="modal fade" id="error_modal" tabindex="-1" role="dialog">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content alert-danger">
	      <div class="modal-body">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h3 class="modal-title">Error</h3>
	        <p class="message"></p>
	      </div>
	    </div>
	  </div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
	<script src="static/js/main.js"></script>
	<script>
		$(document).ready(function()
		{
			update_address_list();

			$('body')
				.on('click', '#network-select a', update_address_list)
				.on('submit', '#transactionform', send_transaction)
				.on('click', '#transactionlogs_copy', copy_logs)
				.on('click', '#transactionlogs_clear', clear_logs)
				.on('click', '#createwallet_button', generate_address);
		});

		function show_spinner(selector)
		{
			$(selector + ' .spinner_reason').hide();
			$(selector + ' .spinner').addClass('active');
		}
		function hide_spinner(selector)
		{
			$(selector + ' .spinner_reason').show();
			$(selector + ' .spinner').removeClass('active');
		}

		var config = {
			net: 'dev'
		};

		var update_address_list = function()
		{
			$('#transactionform_address').html('');
			$('.selectpicker').selectpicker('refresh');

			if($(this)[0].tagName=='A')
			{
				config.net = $(this).data('net');
				$('#network-title')
					.data('net', config.net)
					.find('span').html(config.net);
			}

			var query = {
					method: 'get-list-address',
					net: config.net,
				};

			$.ajax({
				dataType: 'json',
				method: 'GET',
				url: './crypt_example.php',
				data: query,
				success: function(data)
				{
					if(data.error == true)
						return show_error(data.message);
					var transactionform_address = $('#transactionform_address');
					$.each(data, function(key,value){
						transactionform_address.append('<option data-icon="api__option-color" data-subtext="n/a #MHC" id="option' + value + '">' + value + '</option>');
						update_address_balance(value);
					});
					$('.selectpicker').selectpicker('refresh');
				},
				error: function(data)
				{
					console.log('ajax error',data);
					show_error('get-list-address: network error<br>Make sure that you open this page from your web server' );
				}
			});
		}

		var send_transaction = function()
		{
			var query = {
					method: 'send-tx',
					net: config.net,
					address: $('#transactionform_address').val(),
					to: $('#transactionform_to').val(),
					value: $('#transactionform_value').val()*1000000,
					fee: 0,
					data: $('#transactionform_data').val(),
				};

			show_spinner('#btn-send-tx');

			$.ajax({
				dataType: 'json',
				method: 'GET',
				url: './crypt_example.php',
				data: query,
				success: function(data)
				{
					hide_spinner('#btn-send-tx');
					if(data.error == true)
						return show_error(data.message);
					if(data.params)
					{
						if($('.api__empty_lastransrow').length>0)
							$('#transactionshistory tbody').html('');

						$('#transactionshistory tbody').prepend('<tr data-tr="' + data.params + '">' +
							'<td data-title="From"><a>' + query.address + '</a></td>' +
							'<td data-title="To"><a>' + query.to + '</a></td>' +
							'<td data-title="Value">' + mhc_formatter(query.value) + '</td>' +
							'<td data-title="Status"><span class="api__lasttrans-table-stat pen">Pending</span></td>' +
						'</tr>');

						write_log('Transaction ' + data.params + ' started');

						check_transaction(data.params, 0);
					}
					else if(data.error)
					{
						write_log('error: ' + data.error);
					}
					else
					{
						write_log('unknown error');
					}

				},
				error: function(data)
				{
					hide_spinner('#btn-send-tx');
					console.log('ajax error',data);
					show_error('send-tx: network error<br>Make sure that you open this page from your web server');
				}
			});

			return false;
		}

		var check_transaction = function(tx, iteration)
		{
			iteration++;

			var query = {
					method: 'get-tx',
					net: config.net,
					hash: tx,
				};

			$.ajax({
				dataType: 'json',
				method: 'GET',
				url: './crypt_example.php',
				data: query,
				success: function(data)
				{
					if(data.error == true)
						return show_error(data.message);
					if(typeof data.result != 'undefined' && typeof data.result.transaction != 'undefined' && typeof data.result.transaction.transaction != 'undefined')
					{
						$('#transactionshistory tbody tr[data-tr="' + tx + '"] .api__lasttrans-table-stat')
							.removeClass('pen')
							.addClass('suc')
							.html('Success')
						write_log('Transaction ' + tx + ' completed!');
					}
					else if(iteration<10)
					{
						if(data.error)
							write_log(data.error.message);
						setTimeout(check_transaction(tx, iteration), 1000);
					}
					else
					{
						$('#transactionshistory tbody tr[data-tr="' + tx + '"]')
							.addClass('error')
							.find('.api__lasttrans-table-stat')
								.removeClass('pen')
								.addClass('err')
								.html('Error');
						write_log('Transaction ' + tx + ' failed!');
					}
				},
				error: function(data)
				{
					if(iteration<30)
					{
						setTimeout(check_transaction(tx, iteration), 1000);
					}
					else
					{
						$('#transactionshistory tbody tr[data-tr="' + tx + '"]')
							.addClass('error')
							.find('.api__lasttrans-table-stat')
								.removeClass('pen')
								.addClass('err')
								.html('Error');
						write_log('Network proplems. Unknown end of transaction ' + tx);
					}
				}
			});

			return false;
		}

		var generate_address = function(address) 
		{
			var query = {
					method: 'generate',
					net: config.net,
				};

			show_spinner('#createwallet_button');

			$.ajax({
				dataType: 'json',
				method: 'GET',
				url: './crypt_example.php',
				data: query,
				success: function(data)
				{	
					hide_spinner('#createwallet_button');

					if(data.error == true)
						return show_error(data.message);			
					$('#createwallet_input').val(data.address);
					$('#createwallet_success').show();
					$('#transactionform_address').append('<option data-icon="api__option-color" data-subtext="0.000000 #MHC" id="option' + data.address + '">' + data.address + '</option>');
					$('.selectpicker').selectpicker('refresh');
					setTimeout(function(){
						update_address_balance(data.address);
						$('.selectpicker').selectpicker('refresh');
					}, 3000);
				},
				error: function(data)
				{
					hide_spinner('#createwallet_button');
					console.log('ajax error',data);
					show_error('generate: network error<br>Make sure that you open this page from your web server');
				}
			});
		}

		var update_address_balance = function(address) 
		{
			if(address.length!=52)
				return 0;

			var query = {
					method: 'fetch-balance',
					net: config.net,
					address: address
				};

			$.ajax({
				dataType: 'json',
				method: 'GET',
				url: './crypt_example.php',
				data: query,
				success: function(data)
				{
					if(data.error == true)
						return show_error(data.message);
					var balance = data.result.received - data.result.spent;
					$('#option' + data.result.address).data('subtext', mhc_formatter(balance)  + ' #MHC');
					$('.selectpicker').selectpicker('refresh');
				},
				error: function(data)
				{
					console.log('ajax error',data);
					show_error('fetch-balance: network error<br>Make sure that you open this page from your web server');
				}
			});
		}

		var show_error = function(message)
		{
			$('#error_modal')
				.modal('show')
				.find('p.message').html(message);
			return false;
		}
		
		var write_log = function(message) 
		{
			var transactionlogs = $('#transactionlogs'),
				cur_date = new Date(), 
				n = "";

			if(transactionlogs.val().length>0)
				n = "\n";
			else
				$('#transactionlogs_clear, #transactionlogs_copy').removeAttr('disabled');

			transactionlogs.val(transactionlogs.val() + n + cur_date.toLocaleDateString() + ' ' + cur_date.toLocaleTimeString() + ' | ' + message);

			transactionlogs.scrollTop(transactionlogs[0].scrollHeight - transactionlogs.height());
		}

		var copy_logs = function() 
		{
			$('#transactionlogs').select();
			document.execCommand("copy");
			document.getSelection().removeAllRanges();

			$('#transactionlogs_copy').html('Copied!');
			
			setTimeout(function() { 
				$('#transactionlogs_copy').html('Copy');
			}, 2000);
		}

		var clear_logs = function(new_row) 
		{
			$('#transactionlogs').val('');
			$('#transactionlogs_clear, #transactionlogs_copy').attr('disabled','disabled');
		}

		var mhc_formatter = function(number) 
		{
			var decimals = 6,
				dec_point = '.',
				thousands_sep = ',';

			number = number/1000000;
			var n = !isFinite(+number) ? 0 : +number,
				prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),
				sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep,
				dec = (typeof dec_point === 'undefined') ? '.' : dec_point,
				s = '',
				toFixedFix = function(n, prec) {
					var k = Math.pow(10, prec);
					return '' + (Math.round(n * k) / k)
						.toFixed(prec);
				};
			s = (prec ? toFixedFix(n, prec) : '' + Math.round(n))
				.split('.');
			if (s[0].length > 3) {
				s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep);
			}
			if ((s[1] || '')
				.length < prec) {
				s[1] = s[1] || '';
				s[1] += new Array(prec - s[1].length + 1)
					.join('0');
			}
			return s.join(dec);
		}

	</script>
</body>
</html>